<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>给宝宝的致歉</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background: linear-gradient(135deg, #fad0c4 0%, #ff9a9e 100%);
            background-attachment: fixed;
            font-family: 'Helvetica Neue', Arial, 'PingFang SC', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
            padding: 15px;
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* ================= 1. 动态信封开场特效 ================= */
        #envelope-wrapper {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: linear-gradient(135deg, #fad0c4 0%, #ff9a9e 100%);
            z-index: 99999; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            transition: opacity 0.8s ease, transform 0.8s ease;
        }

        .envelope {
            position: relative; width: 280px; height: 180px;
            background: #d65a71; box-shadow: 0 20px 50px rgba(216, 27, 96, 0.5);
            cursor: pointer; transition: transform 0.3s ease;
        }

        .envelope:hover { transform: translateY(-5px); }

        .env-paper {
            position: absolute; top: 10px; left: 10px; right: 10px; bottom: 10px;
            background: #fff; border-radius: 8px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; color: #d81b60;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 1;
        }

        .env-paper h2 { font-size: 18px; margin-bottom: 5px; letter-spacing: 1px; }
        .env-paper p { font-size: 12px; color: #ff758c; }

        .env-front {
            position: absolute; bottom: 0; left: 0;
            border-left: 140px solid transparent; border-right: 140px solid transparent;
            border-bottom: 110px solid #ff9fb0; z-index: 3;
        }

        .env-left-right { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; }
        .env-left-right::before {
            content: ''; position: absolute; top: 0; left: 0;
            border-top: 90px solid transparent; border-bottom: 90px solid transparent; border-left: 140px solid #ff8a9d;
        }
        .env-left-right::after {
            content: ''; position: absolute; top: 0; right: 0;
            border-top: 90px solid transparent; border-bottom: 90px solid transparent; border-right: 140px solid #ff8a9d;
        }

        .env-flap {
            position: absolute; top: 0; left: 0;
            border-left: 140px solid transparent; border-right: 140px solid transparent;
            border-top: 105px solid #ff758c; transform-origin: top;
            transition: transform 0.6s ease, z-index 0.2s; z-index: 4;
        }

        .env-seal {
            position: absolute; top: 105px; left: 50%; transform: translate(-50%, -50%);
            width: 45px; height: 45px; background: #d81b60; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            color: white; font-size: 22px; z-index: 5;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .env-hint {
            margin-top: 40px; color: white; font-size: 15px; letter-spacing: 2px;
            animation: pulse 1.5s infinite; text-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .envelope.open .env-flap { transform: rotateX(180deg); z-index: 0; }
        .envelope.open .env-seal { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
        .envelope.open .env-paper { transform: translateY(-70px); z-index: 3; }

        /* ================= 2. 主页面内容 ================= */
        #main-content {
            width: 100%; display: flex; flex-direction: column; align-items: center;
            opacity: 0; transition: opacity 1.2s ease;
        }

        .header { text-align: center; margin: 40px 0 20px 0; color: #fff; text-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 10; }
        .header h1 { font-size: 26px; font-weight: bold; margin-bottom: 10px; letter-spacing: 2px; }
        .header p { font-size: 14px; opacity: 0.95; line-height: 1.6; }

        .stats {
            background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            padding: 8px 24px; border-radius: 30px; color: #fff; font-size: 14px; font-weight: bold;
            margin-bottom: 25px; box-shadow: 0 4px 15px rgba(255, 107, 129, 0.2);
            position: sticky; top: 15px; z-index: 100; transition: all 0.3s;
        }

        .message-container {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 15px;
            width: 100%; max-width: 600px; padding-bottom: 40px; z-index: 10;
        }

        .msg-card {
            background: rgba(255, 255, 255, 0.65); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.9); padding: 18px; border-radius: 22px;
            color: #5a3a4a; font-size: 15px; line-height: 1.6; box-shadow: 0 8px 32px 0 rgba(255, 154, 158, 0.15);
            transform: translateY(30px) scale(0.95); opacity: 0;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            width: 100%; word-wrap: break-word; position: relative; overflow: hidden;
        }

        /* 纯净版图片样式 */
        .msg-card img { width: 100%; height: auto; display: block; border-radius: 12px; }
        .msg-card.img-mode { text-align: center; background: rgba(255, 255, 255, 0.5); padding: 12px; }
        
        .msg-card.style-emoji { font-size: 28px; text-align: center; background: rgba(255,255,255,0.4); border:none; letter-spacing: 2px; }
        .msg-card.style-sweet { color: #d81b60; font-weight: bold; }
        .msg-card.style-sorry { border-left: 5px solid #ff758c; background: rgba(255, 240, 245, 0.7); }
        .msg-card.show { transform: translateY(0) scale(1); opacity: 1; }

        .msg-card.finale {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); color: #d81b60;
            font-size: 18px; font-weight: bold; text-align: center; padding: 40px 20px;
            border-radius: 24px; box-shadow: 0 15px 40px rgba(255, 117, 140, 0.5);
            margin-top: 30px; border: 3px solid #fff; animation: pulse 2s infinite;
        }

        .msg-num { opacity: 0.6; font-size: 12px; display: block; margin-bottom: 6px; font-family: monospace; color: #ff758c; }
        .img-mode .msg-num { margin-bottom: 8px; }
        .finale .msg-num { color: rgba(216, 27, 96, 0.6); margin-bottom: 15px; }

        .loading-trigger { height: 60px; width: 100%; display: flex; justify-content: center; align-items: center; color: #fff; font-size: 14px; opacity: 0.9; padding-bottom: 20px; }
        .particle { position: fixed; pointer-events: none; z-index: 9999; animation: floatUp ease-out forwards; filter: drop-shadow(0 2px 4px rgba(255, 105, 180, 0.3)); }

        @keyframes floatUp { 0% { transform: translateY(0) scale(0.5) rotate(0deg); opacity: 1; } 100% { transform: translateY(-150px) scale(1.5) rotate(360deg); opacity: 0; } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="envelope-wrapper">
        <div class="envelope" id="envelope">
            <div class="env-paper">
                <h2>致我最爱的宝宝</h2>
            </div>
            <div class="env-left-right"></div>
            <div class="env-front"></div>
            <div class="env-flap"></div>
            <div class="env-seal">❤</div>
        </div>
        <div class="env-hint">拆开信封</div>
    </div>

    <div id="main-content" style="display: none;">
        <div class="header">
            <h1>致我最爱的宝宝</h1>
            <p>以此信以告 心中所念</p>
        </div>
        <div class="stats" id="counter">💗 向上滑，查收... 0/520</div>
        <div class="message-container" id="container"></div>
        <div class="loading-trigger" id="loading">🌸 继续上滑，还有好多想对你说...</div>
    </div>

    <script>
        // ================= 信封交互逻辑 =================
        const envelopeWrapper = document.getElementById('envelope-wrapper');
        const envelope = document.getElementById('envelope');
        const mainContent = document.getElementById('main-content');
        let isOpened = false;

        envelope.addEventListener('click', () => {
            if (isOpened) return;
            isOpened = true;
            envelope.classList.add('open');
            setTimeout(() => {
                envelopeWrapper.style.opacity = '0';
                envelopeWrapper.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    envelopeWrapper.style.display = 'none';
                    mainContent.style.display = 'flex';
                    mainContent.offsetHeight; 
                    mainContent.style.opacity = '1';
                    setTimeout(() => {
                        renderBatch();
                        setTimeout(renderBatch, 800);
                        startParticles();
                    }, 300);
                }, 800);
            }, 1500);
        });

        // ================= 核心数据：151句专属文案 =================
        const baseTexts = [
            "宝宝","那天我真的太迟钝了，没能第一时间接住你的情绪，对不起。", "我现在满脑子都是那天你难过的样子，我恨自己反应那么慢，让你带着委屈过夜", "我知道那天你遇到那些烦心事时最需要我，而我却缺席了那个关键时刻，是我的失职", "对不起。", "你的委屈我现在的都懂了，是我没有在你最脆弱的时候保护好你的心情，反而让你更累", "隔夜气最伤身体，都是我不好，没能那天就哄好你，让你受苦了", "我在反思了，为什么旅游反而让你受委屈了，是我照顾不周，忽略了你的感受", "在那个陌生的城市，我应该是你的依靠，但我那天我却表现得像个局外人", "我不该让你带着情绪过夜，这是我作为男朋友最大的失误", "那些天醒来看到你背对着我，不和我说话，我真的特别难受，我知道那天又又又伤你心了", "九寨沟风景再美，如果你不开心，对我来说就毫无意义，你才是我的风景", "给我一个弥补的机会好吗？那天的那个笨蛋已经不见了，现在是全心全意爱你的我", "那天我知道你烦心，我没有第一时间理解你、哄你，还让你一个人扛着所有情绪，是我太自私了", "对不起，宝宝，我不该在你想倾诉的时候沉默，让你觉得很无助", "不该让你无法倾诉。", "那天我也不是想要真的离开你，走远", "一开始都是跟着的，只是在景区里，我想着去先收拾行李，后面那次是想着去买点东西可能好一点。但这样子肯定都可能只是当时想掩饰不知道怎么做，才那样…", "以后不管发生什么，我一定第一时间站在你这边，不再让你独自消化负面情绪", "让你带着一肚子气睡觉，我真是个混蛋，心疼死我了，以后绝对不许这样了", "旅游本该是开心的，是我把搞砸了，对不起，让我重新来过好吗？", "我知道“对不起”三个字很轻，但我真的真的很愧疚", "你怎么惩罚我都行，就是不要不理我", "我现在的肠子都悔青了，恨不得穿越回那天给自己一拳，把你哄好再睡", "你的情绪不好，我愿意花一整天、一辈子去化解，直到你笑为止", "看着你生闷气，比我自己受委屈还难受，我真的宁愿你可以狠狠骂我一顿出出气", "都是我的错，让你在旅途中还要分心来处理坏情绪，这本该是放松的时刻", "那天是我不对，我不该让你觉得自己是一个人在面对麻烦，我们本该是共同体", "我深刻检讨，我没有及时察觉你的情绪变化，是我不够细心，不够关注你。", "我保证，这是我最后一次让你带着气睡觉，以后天塌下来我也先处理好", "那天是我反应太慢，但我爱你的心绝没有改变，只是表达方式太笨拙", "让你受委屈了，这比任何旅行中的麻烦事都让我难受，我本该好好的和你在一起", "我知道你最近肯定也很委屈，下次我不会这样了，会好好沟通，能接住你的情绪。至少至少不隔夜", "非常非常郑重地向你道歉：对不起，我错了，错在没有及时安抚你，还让情绪隔夜", "我那天就应该直接狠狠的抱住你的，什么都不干真该死", "想吃什么，想买什么，想去哪，我都会听你的", "我也知道你不是因为麻烦事生气，而是因为我的态度冷漠", "真的很抱歉，让你在最需要安慰的时候落空了，那种失落感一定很难受", "那天在床上看着背对着我的你，我甚至不敢大声呼吸，怕吵醒你的委屈，也怕面对你的冷漠，而不知所措", "我就是个笨蛋，总是在事情过后才明白你当时多么无助，这种后知后觉真该死", "旅游中的意外很多，但我应该是那个解决意外的人，对不起", "我现在的状态就是：后悔，非常后悔，超级后悔，请给我个改过自新的机会", "你不原谅我，我真的什么都吃不下", "我发誓，以后不管多累，都不会忽略你的情绪，你会永远是我的最高级", "我知道隔夜气真的好难受好难受", "我不想我们珍贵的旅行时间都浪费在冷战上，我投降，输给你我心甘情愿", "那天是我不对，我不该跟你讲道理，应该好好谈你的感受", "你以后不理我，我会就一直发，一直发到你手机没电，发到你原谅我。", "我知道你已经很烦我，但我不能不找你，我爱你，离不开你", "那天提了分手，真的真的好该死。一想到就想哭。我怎么可以说出这种话", "我以后一定一定不会再那样子说了", "出来玩本来就累，遇到烦心事更烦，我还不管不顾，真的该死", "没有顾及你的身体的影响，也没有顾及到那些烦心事的影响", "我知道在外面旅游，一点烦心事都会被放大，是我没体谅你", "陌生的环境本来就让人没安全感，是我还没给你足够的支撑，让你大晚上的还一个人在外面", "真的好对不起宝宝。", "我知道你期待这次旅行很久了，我不该毁了它", "旅游就是为了放松，结果反而让你更累心了，是我的错，完全背离了初衷", "我知道你因为那些烦心事已经很压抑了，我还是根压死骆驼的最后一根稻草", "你的情绪是合理的，是我的回应是不合格的，错的是我", "我知道你的委屈，不仅仅是因为事儿，更是因为我的态度，那种“事不关己”的态度最伤人", "那天你一个人在外面玩，一定很无助吧，在那个陌生的城市里", "你其实很好哄，是我昨晚太笨，错过了最佳时机，非要等到你也受伤我也受伤", "我知道你为了配合我的旅游的节奏也很累了，是我太自私了", "情绪本来就不应该过夜，会一直一直翻倍，我不知道要怎么可以还得上", "我知道你有时候是需要一个台阶，而我总是没能找到那个台阶", "我也知道小宝讨厌沉默，喜欢可以好好沟通", "我一定要好好改正，不会连沟通都做不到", "我会好好记住昨天的誓言的", "不会再让情绪隔夜", "我会天天起床睡觉都和宝宝说", "我会问宝宝开不开心", "每次想起那天你落寞的样子，我都恨不得立刻冲到你身边抱紧你", "我不该在你最需要陪伴的时候选择逃避，更不该让你一个人承受所有难过", "小宝，我真的知道错了，错在太木讷，错在不懂你的脆弱", "我不该让陌生的城市，成为你委屈的地方，本该是我护你周全", "那些没说出口的安慰，那些没及时给的拥抱，都是我这辈子最后悔的事", "我不该用沉默回应你的难过，更不该让坏情绪在我们之间生根发芽", "我保证，以后再也不会让你在任何地方感到孤单无助", "我错了，不该在你心烦意乱的时候，还计较无关紧要的小事", "以后你的每一次不开心，我都会第一时间回应，绝不拖延半分", "我恨自己的后知后觉，恨自己没能察觉到你的委屈和期待", "小宝，对不起，让你在本该快乐的时光里，流了不该流的眼泪", "我不该提分手，那是我最伤人的话，我永远都不会再说", "我会学会读懂你的小情绪，再也不让你失望", "坏情绪绝对不能过夜，这是我对你的承诺，也是我必须遵守的底线", "我真的好怕失去你，怕你再也不原谅我，怕我们就这样走散", "我会把这次的教训刻在心里，时时刻刻提醒自己，要好好爱你", "我不该在你想被呵护的时候，给你冷漠，给你距离，给你委屈", "我会学着好好沟通，再也不冷战，再也不沉默，再也不逃避", "我不该让旅行变成你的伤心事，本该是满满的甜蜜和美好", "一想到那些日子，我就觉得无比煎熬，度日如年", "我会每天都告诉你我有多爱你，再也不让你感受不到我的心意", "小宝，对不起，是我辜负了你的期待，辜负了我们的旅行", "我不该在你最脆弱的时候，缺席你的世界，让你独自难过", "以后不管发生什么，我都会紧紧抱着你，绝不松手，绝不走远", "你值得被好好宠爱，被好好呵护，而不是受我带来的委屈", "我愿意为你改变所有的不好，变成你喜欢的样子，只要你不离开", "我再也不会说伤人的话，再也不会做伤你的事，再也不会让你哭", "以后你的每一句话，我都会认真听，你的每一个情绪，我都会在意", "我真的不能没有你，没有你的日子，一切都变得毫无意义", "小宝，原谅我这一次好不好，我真的会改，会用行动证明", "我不该让自己的迟钝，伤害你", "我会每天都跟你说早安、午安、晚安，再也不让你感受不到我的存在", "以后你不开心，我就立刻认错，立刻哄你，绝不讲道理，", "我真的好珍惜你，珍惜我们的感情，不想因为我的错毁掉一切", "我会学着做一个合格的男朋友，接住你的所有情绪", "这些日子，我每天都在反省，每天都在后悔，每天都想你", "小宝，原谅我这个笨蛋，原谅我这次的过错，好不好", "我会把你的情绪放在最高优先级，任何事都比不上你的开心", "我不该在你需要我的时候，选择离开，选择走远，选择逃避", "以后不管遇到什么烦心事，我们一起面对，一起解决，不分开", "小宝，我真的改了，真的懂了，懂了你的情绪，懂你的委屈", 
            // ----- 这里是分水岭，前112句结束，后面是哄回/表白期 -----
            "我也很想给小宝买东西，不只是弥补，即使平时也是。", "给小宝买奶茶🍹。", "给小宝买包包👝。", "给小宝买戒指💍。", "给小宝买项链📿。", "给小宝买玩偶🐻。", "给小宝买衣服👗。", "给小宝买鞋子👞。", "给小宝买好多好多，只要小宝喜欢。", "你的快乐就是我最大的成就，也是我最快乐的事，真的好开心。", "我想一直牵着你的手，走遍天涯海角，哪怕偶尔会迷路，只要手牵着就不怕。", "你是我生命中最重要的人，不想要失去了你。", "我愿意花一辈子的时间来学习如何更好地爱你。", "这次是我不好，但我爱你的心是真的，比真金还真。", "我想和你从天光乍破走到暮雪白头。", "这一次的争吵，会是下一次更好的相拥，我会更懂珍惜。", "我们真的真的和好吧，想要和你在一起。", "晓看天色暮看云，行也思君，坐也思君。", "我好想和你虚度时光，比如把奶茶喝到剩下冰块，比如在长椅上发呆。", "想和你一直一直的聊天。", "执子之手，与子偕老。", "我想包容你的一切。", "我爱你，从过去到现在，直到未来。", "我们在吵架，我好想抱抱你，但我却总是退怯，下次我一定要狠狠抱住你。", "你是我的唯一，没人能替代，以前没有，以后也不会有。", "我想和你一起收集地图上的风和日丽，把那些阴霾都吹散。", "我对你的爱，像鱼儿缺氧于六千四百米的深海，深沉且无法呼吸。", "你是我所有的少女情怀和心之所向，是我所有浪漫的归宿。", "我想把世界上最好的东西都给你，包括我的耐心，不会让它有时候离家出走。", "我爱你，小宝。", "愿得一心人，白头不相离", "我想和你一起看日出日落，虽然我们黄山和玉龙雪山都没有看到，但我那时候的心情也是好开心好开心。", "你的存在，本身就是治愈我的一切良药。", "我想和你一起慢慢变老，老到哪儿也去不了，只能互相依偎。", "我想把对你的相思，写进每一行发给你的代码里。", "我收到了你的手捧花，非常的好看。", "天涯地角有穷时，只有相思无尽处。", "我们要把愿望一个一个清空。", "我会一直爱你，直到世界尽头，海枯石烂。"
        ];

        // 扩充的纯 Emoji 情绪库
        const sadEmojis = [
            "🥺🥺🥺", "😭😭😭", "💔💔💔", "😞😞😞", "😔😔😔", 
            "🌧️☔💧", "🥀🥀🥀", "🥺💔😭", "😿😿😿", "🙇‍♂️🙇‍♂️🙇‍♂️", 
            "🙏🙏🙏", "😥😥😥", "😢😢😢", "😣😣😣", "😫😫😫", 
            "🧎‍♂️🧎‍♂️🧎‍♂️", "🖤🖤🖤", "🥀💔😢", "🥺👉👈", "🐶🥺🐾", 
            "🥺😭💔", "🤕🤕🤕", "🩹🩹🩹", "🙍‍♂️🙍‍♂️🙍‍♂️", "💧🌧️🌩️"
        ];
        
        const happyEmojis = [
            "🧋🍰🍩", "❤️🧡💛💚💙💜", "💖💗💓", "✨🌟💫", "🥰🥰🥰", 
            "😘😘😘", "💕💞💘", "🌹🌷💐", "😻😽😻", "🎀🎊🎉", 
            "🎁🎈🎁", "🍓🍒🍎", "🍬🍭🍫", "👩‍❤️‍👨👩‍❤️‍👨👩‍❤️‍👨", "💑💑💑", 
            "💞💝💖", "💍💎💐", "🧸🧸🧸", "🍯🍯🍯", "🍔🍟🥤", 
            "🍦🍧🍨", "🥰😘😍", "🥺❤️✨", "💘💌💋", "🐰💕✨", 
            "🐱❤️🐾", "🌹🍓🍒", "👗👜💄", "🛫🏖️🌅", "🎡🎢🎠", 
            "🌸🌺🌻", "🌟🌙✨", "❤️🔥❤️🔥", "🥰🧸💕", "😽🫶💖", 
            "🍓🍰🥤", "🧋🍟🍔", "💐💖💍", "💌🕊️💕", "🧸🎀✨"
        ];

        // ================= 智能生成算法（终极优化版：112句伤心阶段 + 完美发牌节奏） =================
        let fullCorpus = [];
        const targetTotal = 520;

        // 1. 创建伤心图片池：包含 1-11 号图片各两次
        let sadImagePool = [];
        for (let i = 1; i <= 11; i++) {
            sadImagePool.push(i, i); 
        }
        // 洗牌算法
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        shuffleArray(sadImagePool);

        for (let i = 0; i < baseTexts.length; i++) {
            // 【关键修改1】：前 112 句视为伤心检讨阶段
            let isSadPhase = i < 112;
            let msgType = isSadPhase ? "style-sorry" : "style-sweet";
            fullCorpus.push({ text: baseTexts[i], type: msgType });

            if (i === baseTexts.length - 1) break;

            let fillersToInsert = (i % 2 === 0) ? 2 : 3;
            let remainingSlots = targetTotal - 1 - fullCorpus.length; 
            let remainingIntervals = baseTexts.length - 1 - i - 1;
            if (remainingIntervals === 0) fillersToInsert = remainingSlots;

            for (let j = 0; j < fillersToInsert; j++) {
                if (fullCorpus.length >= targetTotal - 1) break;

                // 【关键修改2】：动态调整图片概率，确保22张伤心图片能均匀撑满整个前112句的长度
                // 伤心阶段概率降至 10% 左右（让22张图散布在280个坑位里）
                // 甜蜜阶段概率拉升至 70% 左右（满屏甜蜜暴击）
                let isImage = isSadPhase ? (Math.random() < 0.1) : (Math.random() < 0.7); 

                if (isImage) {
                    let imgNum;
                    if (isSadPhase) {
                        if (sadImagePool.length > 0) {
                            imgNum = sadImagePool.pop();
                        } else {
                            // 池子空了，回退到颜文字
                            isImage = false;
                        }
                    } else {
                        imgNum = Math.floor(Math.random() * 63) + 12; 
                    }

                    if (isImage) {
                         fullCorpus.push({ image: `image (${imgNum}).png` });
                    }
                }
                
                if (!isImage) {
                    let emojiPool = isSadPhase ? sadEmojis : happyEmojis;
                    let emojiText = emojiPool[Math.floor(Math.random() * emojiPool.length)];
                    fullCorpus.push({ text: emojiText, type: 'style-emoji' });
                }
            }
        }

        // ================= 渲染瀑布流逻辑 =================
        const container = document.getElementById('container');
        const counter = document.getElementById('counter');
        const loading = document.getElementById('loading');
        
        let currentCount = 0;
        const batchSize = 15; 
        let isGenerating = false; 

        function renderBatch() {
            if (isGenerating || currentCount >= targetTotal) return;
            isGenerating = true;

            let end = Math.min(currentCount + batchSize, targetTotal);
            let fragment = document.createDocumentFragment();
            let newCards = [];
            
            for (let i = currentCount; i < end; i++) {
                const card = document.createElement('div');
                card.className = 'msg-card';
                
                if (i === targetTotal - 1) {
                    card.classList.add('finale');
                    card.innerHTML = `<span class="msg-num">✨ Message No.520 ✨</span>
                        <br>感谢你耐心滑到这里。<br>
                        前面有笨拙的检讨，<br>有撒娇的表情包，<br>但这一句才是永远的底色：<br><br>
                        <span style="font-size: 24px; color: #d81b60;">${fullCorpus[i].text}</span><br><br>
                        未来的路，请允许我继续牵着你走。❤️`;
                } else {
                    const msgObj = fullCorpus[i];
                    let contentHtml = `<span class="msg-num">No.${i + 1}</span>`;

                    if (msgObj.image) {
                        card.classList.add('img-mode');
                        contentHtml += `<img src="${msgObj.image}" alt="表情包">`;
                    } else {
                        if(msgObj.type) card.classList.add(msgObj.type);
                        contentHtml += msgObj.text;
                    }
                    card.innerHTML = contentHtml;
                }
                fragment.appendChild(card);
                newCards.push(card);
            }

            container.appendChild(fragment);
            currentCount = end;

            newCards.forEach((card, index) => {
                setTimeout(() => {
                    card.classList.add('show');
                    counter.innerText = `💗 已送达: ${currentCount} / 520`;
                }, index * 80); 
            });

            setTimeout(() => {
                isGenerating = false;
                if (currentCount >= targetTotal) {
                    loading.innerHTML = "✨ 520 份偏爱已全部送达，快去抱抱他吧！✨";
                }
            }, newCards.length * 80 + 200);
        }

        window.addEventListener('scroll', () => {
            const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
            const scrollHeight = document.documentElement.scrollHeight || document.body.scrollHeight;
            const clientHeight = document.documentElement.clientHeight || window.innerHeight;

            if (scrollTop + clientHeight >= scrollHeight - 300) {
                renderBatch();
            }
        });

        // ================= 满屏浪漫粒子特效 =================
        const emojis = ['❤️', '💖', '🌸', '🎀', '💕', '✨', '💌'];
        function createParticle(x, y) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.innerText = emojis[Math.floor(Math.random() * emojis.length)];
            const size = Math.random() * 18 + 12; 
            const duration = Math.random() * 2 + 1.5; 
            particle.style.left = `${x}px`;
            particle.style.top = `${y}px`;
            particle.style.fontSize = `${size}px`;
            particle.style.animationDuration = `${duration}s`;
            document.body.appendChild(particle);
            setTimeout(() => particle.remove(), duration * 1000);
        }

        function startParticles() {
            setInterval(() => {
                createParticle(Math.random() * window.innerWidth, window.innerHeight);
            }, 800);

            window.addEventListener('pointerdown', (e) => {
                if (e.target.closest('#envelope-wrapper')) return;
                for(let i=0; i<4; i++) {
                    setTimeout(() => {
                        const offsetX = (Math.random() - 0.5) * 50;
                        const offsetY = (Math.random() - 0.5) * 50;
                        createParticle(e.clientX + offsetX, e.clientY + offsetY);
                    }, i * 80);
                }
            });
        }
    </script>
</body>
</html>


